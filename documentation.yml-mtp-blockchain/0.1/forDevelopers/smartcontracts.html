<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Knowledge Base - Smart contracts :: Antora Docs</title>
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a>MTP-Blockchain</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="documentation.yml-mtp-blockchain" data-version="0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">MTP-Blockchain</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Master Team Project</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../masterTeamProject/masterProject.html">A Blockchain-based system for course submissions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">For Students</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../forStudents/guide.html">Guide for Knowledge Base</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../forStudents/metamask.html">Metamask Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">For Lecturers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../forLecturers/raspberry.html">Raspberry Pi setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../forLecturers/basicRaspberrySetup.html">Basic Raspberry Pi setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../forLecturers/frontendFaucetRaspberrySetup.html">Frontend &amp; Faucet Raspberry Pi setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../forLecturers/minerRPCRaspberrySetup.html">Miner Node &amp; RPC Node Raspberry Pi setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../forLecturers/newSemester.html">Start a new semester</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../forLecturers/adminFunctions.html">Admin functions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">For Developers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="frontend.html">Frontend &amp; Blockchain interaction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="smartcontracts.html">Knowledge Base - Smart contracts</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">MTP-Blockchain</span>
    <span class="version">0.1-beta.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">MTP-Blockchain</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.1-beta.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">MTP-Blockchain</a></li>
    <li>For Developers</li>
    <li><a href="smartcontracts.html">Knowledge Base - Smart contracts</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Knowledge Base - Smart contracts</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Knowledge Base runs completely on-chain and consists out of different smart contracts which interact with each other.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configstorage_sol"><a class="anchor" href="#_configstorage_sol"></a><code>ConfigStorage.sol</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract is the central component of the Knowledge Base. It stores all the configuration data of the Knowledge Base. The configuration data is stored in various mappings and parameters. The conract also contains functions to set and get the configuration data. The <code>ConfigStorage.sol</code> smart contract inherits the <code>BaseConfigAdmin.sol</code> smart contract. The <code>BaseConfigAdmin.sol</code> smart contract contains functions to add and remove admins and contract admins.</p>
</div>
<div class="paragraph">
<p>The system differentiated between two types of admins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>User Admin</strong> - The user admin can be a professor, teaching assistant or system admin. User admins can change the configuration of the system and add and remove admins.</p>
</li>
<li>
<p><strong>Contract Admin</strong> - The contract admin are contracts that need special permissions to interact with the Knowledge Base. Usually all contracts that are part of the Knowledge Base are contract admins.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This role management system is used to ensure that only trusted users or contracts can access or change the configuration data of the Knowledge Base. This is especially important for the <code>SBCoin.sol</code> and validator smart contract. Because only admins should be allowed to transfer <em>Knowledge Coins</em>.</p>
</div>
<div class="sect2">
<h3 id="_parameters"><a class="anchor" href="#_parameters"></a>Parameters</h3>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract stores the configuration data in various parameters. The parameters are used to store the configuration data in a more efficient way. The parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>uint128 faucetGas;</code> - The amount of gas the faucet can send to a user.</p>
</li>
<li>
<p><code>uint128 faucetBlockNoDifference;</code> - The amount of blocks need to be passed before the faucet can be used again.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_inherited_parameters_from_baseconfigadmin_sol"><a class="anchor" href="#_inherited_parameters_from_baseconfigadmin_sol"></a>Inherited parameters from <code>BaseConfigAdmin.sol</code></h4>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract inherits the following parameters from the <code>BaseConfigAdmin.sol</code> smart contract:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>address[] private admins;</code> - Stores the addresses of the admins.</p>
</li>
<li>
<p><code>ContractAdmin[] private contractAdmins;</code> - Stores the contract admins.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mappings"><a class="anchor" href="#_mappings"></a>Mappings</h3>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract stores the configuration data in various mappings. The mappings are used to store the configuration data in a more efficient way. The mappings are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mapping(uint256 &#8658; NOWSemester) semesters;</code> - Stores the semesters of the Knowledge Base. The key of the mapping is the semester ID. The value of the mapping is a <code>NOWSemester</code> struct.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_structs"><a class="anchor" href="#_structs"></a>Structs</h3>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract stores the configuration data in various structs. The structs are used to store the configuration data in a more efficient way. The structs are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>struct NOWSemester {&#8230;&#8203;}</code> - Stores the data of a semester. The struct contains the following parameters:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>struct NOWSemester {
    string name; // Name of the semester (e.g. SS22)
    uint256 startBlock; // First block which counts towards this semester
    uint256 endBlock; // Last block which counts towards this semester
    uint256 minKnowledgeCoinAmount; // Amount of knowledge Coins needed to take exam
    uint256 assignmentCounter; // Assignment counter
    uint256[] assignmentIds; // Assignment Ids
    mapping(uint256 =&gt; NOWAssignments) assignments; // Assigned assignments
    // TEMP VARIABLES
    uint256 assignmentStartBlock; // Temp var to keep track of lowest start block of all assignments
    uint256 assignmentEndBlock; // Temp var to keep track of highest end block of all assignments
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>struct NOWAssignment {&#8230;&#8203;}</code> - Stores the data of an assignment. The struct contains the following parameters:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>struct NOWAssignments {
    string name; // Name of the assignment
    string link; // Link to the assignment
    address validationContractAddress; // Address to the validation contract
    uint256 startBlock; // First block which counts towards this assignment
    uint256 endBlock; // Last block which counts towards this assignment
}</pre>
</div>
</div>
<div class="sect3">
<h4 id="_inherited_structs_from_baseconfigadmin_sol"><a class="anchor" href="#_inherited_structs_from_baseconfigadmin_sol"></a>Inherited structs from <code>BaseConfigAdmin.sol</code></h4>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract inherits the following structs from the <code>BaseConfigAdmin.sol</code> smart contract:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>struct ContractAdmin {&#8230;&#8203;}</code> - Stores the data of an admin. The struct contains the following parameters:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>struct ContractAdmin {
    string contractName; // Name of contract
    address contractAddress; // Address of contract
    bool isContractAdmin; // Is contract admin
}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions"><a class="anchor" href="#_functions"></a>Functions</h3>
<div class="paragraph">
<p>The <code>ConfigStorage.sol</code> smart contract contains various functions. The paramaters, mappings and structs are used in the functions and can be setted or getted. For detailed descriptions of the functions, please see the comments in the <code>ConfigStorage.sol</code> smart contract.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sbcoin_sol"><a class="anchor" href="#_sbcoin_sol"></a><code>SBCoin.sol</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>SBCoin.sol</code> smart contract is the contract which stores the <em>Knowledge Coin</em> in short <em>NOW</em>. This coin is the main currency of the Knowledge Base system and the payment students receive for successfully passing tests on their submitted assignments.</p>
</div>
<div class="paragraph">
<p>All the functions of the contract are described in the comments to the code. The contract is written in Solidity language and compiled with the help of the <code>solc</code> compiler.</p>
</div>
<div class="sect2">
<h3 id="_security"><a class="anchor" href="#_security"></a>Security</h3>
<div class="paragraph">
<p>All minting, transfer or burning functions are restricted to user or contract admins. This ensures that only the contract owner can mint new coins and that only the contract owner or the contract admin can transfer coins to other users. So students cannot send coins to each other to cheat the system.</p>
</div>
<div class="paragraph">
<p>To ensure that students cannot reuse the Knowledge Coins from a previous semester, the Knowledge Coins are bounded to a block range. So students can only use the Knowledge Coins they received in the current semester for qualifying themselves for the current semester exam. This is done by the <code>mint</code> function. The <code>mint</code> function can only be called by user or contract admins and sends the amount of Knowledge Coins to the student&#8217;s address and logs the amount with the current block number.</p>
</div>
<div class="paragraph">
<p>The <code>burn</code> function can burn Knowledge Coins from the student&#8217;s address. This function is also restricted to user or contract admins. Coins are burned by transferring them to a 0x0 address using the <code>_transfer</code> function.</p>
</div>
<div class="paragraph">
<p>The basic <code>_transfer</code> and <code>_approve</code> functions can only be called by user or contract admins. The <code>_transfer</code> function is used to transfer Knowledge Coins from one address to another. The <code>_approve</code> function is used to approve another address to spend a certain amount of Knowledge Coins from the sender&#8217;s address.</p>
</div>
<div class="paragraph">
<p>The <code>_transfer</code> function also keeps track of the change of coins for the block number restriction.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faucetstorage_sol"><a class="anchor" href="#_faucetstorage_sol"></a><code>FaucetStorage.sol</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>FaucetStorage.sol</code> smart contract is the contract which allows students to request ETH. To mock a real system and create an artificial value for ETH. ETH can only be requested after a certain block time. This block difference can be modified in the <code>ConfigStorage.sol</code>.</p>
</div>
<div class="paragraph">
<p>All the functions of the contract are described in the comments to the code. The contract is written in Solidity language and compiled with the help of the <code>solc</code> compiler.</p>
</div>
<div class="paragraph">
<p>Every student can request ETH from the contract. The contract will check if the student has already requested ETH in the defined block difference range. If not the contract will send ETH to the student and store the block number of the transaction. If the student has already requested ETH in the defined block difference range, the contract will not send ETH to the student.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_assignment_validator"><a class="anchor" href="#_assignment_validator"></a>Assignment Validator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is an explanation of the concept of the assignment validators.</p>
</div>
<div class="paragraph">
<p>The job of the assignment validator is to check the validity of the assignment. The contract is doing this by interacting with the assignment of the student and calling different functions and checking the return values or the change of the state of the contract.</p>
</div>
<div class="paragraph">
<p>Each assignment validator, for convenience we call it <em>validator</em>, is pack of different contracts.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/validator_example.png" alt="validator example">
</div>
</div>
<div class="paragraph">
<p>Contracts in the:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>/helper</strong> directory are contracts that are used by the validator to check the validity of the assignment. They usually create components like an exchange of registry which are used by the validator or students.</p>
</li>
<li>
<p><strong>/interface</strong> directory are contracts that store the interface of the assignment. They are used by the validator to call the functions of the assignment. The student needs to name his functions in the same way as written in the interface and also define the input and output parameters in the same way.</p>
</li>
<li>
<p>base directory contains the validator contracts. The contract without any suffix e.g. <em>Validator2.sol</em> is the main validator contract. The other contracts e.g. <em>Validator2TaskC.sol</em> are used to check single tasks, for this file it only checks tasks which where requested in <em>Task C</em> of the assignment. The vase validator is organizing the calls to the task validators and is also responsible for the payment of the student.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_process"><a class="anchor" href="#_process"></a>Process</h3>
<div class="paragraph">
<p>The student calls the <code>test(address)</code> function using the React frontend. He passes his assignment contract address. The validator than runs various tests on this contract. For each passed task the student receives a certain amount of predefined tokens. <strong>No subpoints can be paid out</strong>. The student can call the <code>test(address)</code> function as often as he wants. Each test gets registered and stored in a mapping. The result of the test can be accessed via the test id. This allows the student to see which tasks he passed and which not. The student can also see the reason why a task was not passed.</p>
</div>
<div class="paragraph">
<p>If the student is happy with the result he can call the <code>submit(address)</code> function. This function will test the assignment again and then pays the student the tokens he earned. The student can only call this function once. After the student called this function the validator will not accept any more submit for this assignment.</p>
</div>
<div class="paragraph">
<p>The contract needs to be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deployed and submitted in block range of the assignment</p>
</li>
<li>
<p>The student needs to be the owner of the contract</p>
</li>
<li>
<p>No other submission is registered for this assignment by the <code>msg.sender</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The student always needs to call the <code>test(address)</code> and <code>submit(address)</code> function by their own. Because the system checks if the <code>msg.sender</code> is the owner of the contract. Furhter the <code>msg.sender</code> receives the tokens. Ensure to not try to submit an assignment via another contract.</p>
</li>
<li>
<p>The owner of the contract is trackd by the <code>BaseAssignment.sol</code> contract. The <code>BaseAssignment.sol</code> is inherited by the validator. To set the owner the function <code>setAssignmentOwner</code> takes the <code>msg.sender</code> as the contract address and the <code>tx.origin</code> as the owner. So here the <code>setAssignmentOwner</code> <strong>must be called by the student contract</strong>. If the student is using a proxy contract the <code>setAssignmentOwner</code> function will log the wrong contract address. This will result in the fact that the student cannot submit the assignment.</p>
</li>
<li>
<p>It is only possible to once set the block creation and contract admin.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_security_2"><a class="anchor" href="#_security_2"></a>Security</h3>
<div class="paragraph">
<p>To ensure that the student who submits the assignment is really the owner of the contract. Each student needs to inherit his assignment from the <code>BaseAssignment.sol</code> contract. This contract stores calls the corresponding validator contract and stores the <em>owner</em> and <em>block number</em> of creation. By storing the owner and the block number of creation we can ensure that the student is the owner of the contract and that the student is not trying to submit an assignment which is too old. Further the student cannot change the values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_admin"><a class="anchor" href="#_admin"></a>Admin</h3>
<div class="paragraph">
<p>It is possible to remove an already submitted Assignment by calling the <code>removeSubmittedAssignment(address)</code> function. This function is of course restricted to user or contract admins. The function will remove the assignment from the mapping and the student can submit the assignment again. BUT the student will also lose the tokens he already earned (<code>burn</code> function used).</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
